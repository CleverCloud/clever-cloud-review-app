"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.withCache = withCache;
exports.ONE_DAY = exports.ONE_SECOND = exports.NO_CACHE = void 0;

var _pickNonNull = require("./pick-non-null.js");

const cache = new Map();

function getKey(cacheParams) {
  const objectKey = (0, _pickNonNull.pickNonNull)(cacheParams, ['API_HOST', 'WARP_10_HOST', 'API_OAUTH_TOKEN', 'API_OAUTH_TOKEN_SECRET', 'OAUTH_CONSUMER_KEY', 'OAUTH_CONSUMER_SECRET', 'method', 'url', 'queryParams']);
  return JSON.stringify(objectKey);
}

const NO_CACHE = 0;
exports.NO_CACHE = NO_CACHE;
const ONE_SECOND = 1000;
exports.ONE_SECOND = ONE_SECOND;
const ONE_DAY = 1000 * 60 * 60 * 24;
exports.ONE_DAY = ONE_DAY;

function withCache(cacheParams, cacheDelay = ONE_SECOND, createPromise) {
  const cacheKey = getKey(cacheParams);

  if (cacheParams.method === 'get' && cache.has(cacheKey) && cacheDelay !== NO_CACHE) {
    return cache.get(cacheKey);
  }

  const promise = createPromise();

  if (cacheParams.method === 'get' && cacheDelay !== NO_CACHE) {
    cache.set(cacheKey, promise);
    setTimeout(() => {
      cache.delete(cacheKey);
    }, cacheDelay);
  }

  return promise;
}